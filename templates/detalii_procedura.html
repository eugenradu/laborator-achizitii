{% extends 'base.html' %}

{% block content %}
<h2>Detalii Procedură: {{ procedura.Nume_Procedura }}</h2>
<p>ID Procedură: <strong>#{{ procedura.ID_Procedura }}</strong></p>
<p>Tip: <strong>{{ procedura.Tip_Procedura.value }}</strong></p>
<p>Stare: <strong>{{ procedura.Stare }}</strong></p>
<p>Data Creare: <strong>{{ procedura.Data_Creare.strftime('%d-%m-%Y') }}</strong></p>
<p>Creat de: <strong>{{ procedura.creator_procedura.Nume_Utilizator if procedura.creator_procedura else 'N/A'
        }}</strong></p>

<div class="actions">
    <a href="{{ url_for('proceduri.genereaza_documentatie', procedura_id=procedura.ID_Procedura) }}"
        class="button-secondary">Generează Documentație (.txt)</a>
</div>

<h3>Loturi Incluse în Procedură</h3>

{% for lot_id, data in loturi_cu_oferte.items() %}
<div class="lot-container">
    <h4>Lot #{{ data.lot_obj.ID_Lot }}: {{ data.lot_obj.Nume_Lot }}</h4>
    <p>
        <small>
            (Provenit din
            <a href="{{ url_for('referate.detalii_referat', referat_id=data.lot_obj.referat_parinte.ID_Referat) }}">
                Referat #{{ data.lot_obj.referat_parinte.ID_Referat }}
            </a>)
        </small>
    </p>
    {% if data.lot_obj.Descriere_Lot %}<p>Descriere: <span class="pre-formatted-text">{{
            data.lot_obj.Descriere_Lot }}</span></p>{% endif %}

    <h5>Produse în Acest Lot</h5>
    <table>
        <thead>
            <tr>
                <th>Nume Generic Produs</th>
                <th>Cantitate Solicitată (U.M.)</th>
            </tr>
        </thead>
        <tbody>
            {% for prod, pir in data.produse %}
            <tr>
                <td>{{ prod.Nume_Generic }}</td>
                <td>{{ pir.Cantitate_Solicitata }} {{ prod.Unitate_Masura }}</td>
            </tr>
            {% else %}
            <tr>
                <td colspan="2">Acest lot nu conține produse.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <h5 style="margin-top: 20px;">Analiză Oferte pentru Acest Lot</h5>
    {% if data.oferte_comparative %}
    <table>
        <thead>
            <tr>
                <th>Furnizor</th>
                <th>Valoare Ofertată (Lot)</th>
                <th>Nr. Articole Ofertate</th>
                <th>Acțiuni</th>
            </tr>
        </thead>
        <tbody>
            {% for oferta, valoare, nr_articole in data.oferte_comparative %}
            <tr>
                <td>
                    <a href="{{ url_for('oferte.detalii_oferta', oferta_id=oferta.ID_Oferta) }}">
                        {{ oferta.furnizor.Nume_Furnizor }} (Oferta #{{ oferta.ID_Oferta }})
                    </a>
                </td>
                <td><strong>{{ "%.2f"|format(valoare) }} {{ oferta.Moneda }}</strong></td>
                <td>{{ nr_articole }} / {{ data.produse|length }}</td>
                <td>
                    <a href="{{ url_for('contracte.adauga_contract', oferta_id=oferta.ID_Oferta, lot_id=data.lot_obj.ID_Lot) }}"
                        class="button">Generează Contract</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>Nu au fost primite oferte care să acopere produsele din acest lot.</p>
    {% endif %}
</div>
{% else %}
<p>Această procedură nu are loturi asociate.</p>
{% endfor %}

<hr style="margin-top: 30px; margin-bottom: 30px;">

<h3>Management Oferte</h3>
<div class="actions" style="margin-bottom: 15px;">
    <a href="{{ url_for('oferte.adauga_oferta', procedura_id=procedura.ID_Procedura) }}" class="button">Adaugă Ofertă
        pentru Această Procedură</a>
</div>

<style>
    .lot-container {
        border: 1px solid #ccc;
        padding: 15px;
        margin-top: 20px;
        border-radius: 8px;
    }
</style>
{% endblock %}