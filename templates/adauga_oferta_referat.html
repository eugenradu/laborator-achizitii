{% extends 'base.html' %}

{% block content %}
    <h2>Adaugă Ofertă pentru Referat #{{ referat_id }}</h2>

    <form method="POST">
        <label for="nume_distribuitor">Nume Distribuitor:</label><br>
        <input type="text" id="nume_distribuitor" name="nume_distribuitor" required><br><br>

        <label for="data_oferta">Data Ofertă:</label><br>
        <input type="date" id="data_oferta" name="data_oferta" value="{{ today }}" required><br><br>

        <label for="id_produs_referat">Produs Generic Solicitat:</label><br>
        <select id="id_produs_referat" name="id_produs_referat" required>
            <option value="">-- Selectează un produs --</option>
            {% for pir, prod in produse_in_referat_generic %}
                <option value="{{ pir.ID_Produs_Referat }}" data-prod-generic-id="{{ prod.ID_Produs }}">{{ prod.Nume_Generic }} (Cant: {{ pir.Cantitate_Solicitata }})</option>
            {% endfor %}
        </select><br><br>

        <label for="id_varianta_comerciala">Varianta Comercială Ofertată:</label><br>
        <select id="id_varianta_comerciala" name="id_varianta_comerciala" required disabled>
            <option value="">-- Mai întâi selectează un produs --</option>
        </select>
        <button type="button" id="add-variant-btn" class="add-variant-btn" disabled>+ Adaugă Variantă Nouă</button>
        <br><br>

        <label for="pret_unitar_pachet">Preț Unitar Pachet:</label><br>
        <input type="number" id="pret_unitar_pachet" name="pret_unitar_pachet" step="0.01" min="0" required><br><br>

        <label for="moneda">Monedă:</label><br>
        <input type="text" id="moneda" name="moneda" value="RON"><br><br>

        <button type="submit">Salvează Oferta</button>
    </form>

    <!-- Modal pentru adăugare variantă nouă -->
    <div id="addVariantModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h4>Adaugă Variantă Comercială Nouă</h4>
            <form id="addVariantForm">
                <input type="hidden" id="modalProdusGenericId" name="id_produs_generic">
                
                <label for="modalProducator">Producător:</label>
                <select id="modalProducator" name="id_producator" required>
                    <option value="">-- Selectează un producător --</option>
                    {% for producator in producatori %}
                        <option value="{{ producator.ID_Producator }}">{{ producator.Nume_Producator }}</option>
                    {% endfor %}
                </select>

                <label for="modalCodCatalog">Cod Catalog:</label>
                <input type="text" id="modalCodCatalog" name="cod_catalog" required>
                
                <label for="modalDescriereAmbalare">Descriere Ambalare:</label>
                <input type="text" id="modalDescriereAmbalare" name="descriere_ambalare" placeholder="ex: Kit 48 teste" required>

                <label for="modalCantitateStandard">Cantitate Standard Ambalare:</label>
                <input type="number" id="modalCantitateStandard" name="cantitate_standard_ambalare" min="1" required>

                <label for="modalNumeComercial">Nume Comercial Extins (opțional):</label>
                <input type="text" id="modalNumeComercial" name="nume_comercial_extins">
                
                <button type="submit">Salvează Varianta</button>
                <div id="modalError" class="error-message"></div>
            </form>
        </div>
    </div>

    <style>
        .add-variant-btn {
            font-size: 0.8em;
            padding: 4px 8px;
            margin-left: 5px;
        }
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .error-message {
            color: #721c24;
            margin-top: 10px;
        }
    </style>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Preluăm variantele pre-procesate din Python. Este mai curat și mai sigur.
        const allVariants = {{ variants_for_js | tojson | safe }};
 
        const produsSelect = document.getElementById('id_produs_referat');
        const variantaSelect = document.getElementById('id_varianta_comerciala');
        const addVariantBtn = document.getElementById('add-variant-btn');
        let currentProdGenericId = null;
 
        produsSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            currentProdGenericId = selectedOption.dataset.prodGenericId;
 
            variantaSelect.innerHTML = '<option value="">-- Selectează o variantă --</option>';
            if (currentProdGenericId) {
                const relevantVariants = allVariants.filter(v => v.prod_generic_id == currentProdGenericId);
                relevantVariants.forEach(v => {
                    const option = new Option(v.text, v.id);
                    variantaSelect.appendChild(option);
                });
                variantaSelect.disabled = false;
                addVariantBtn.disabled = false;
            } else {
                variantaSelect.disabled = true;
                addVariantBtn.disabled = true;
            }
        });
 
        // Logica pentru modal (identică cu cea de la oferte licitație)
        const modal = document.getElementById('addVariantModal');
        const closeModalButton = modal.querySelector('.close-button');
        const addVariantForm = document.getElementById('addVariantForm');
        const modalProdusGenericIdInput = document.getElementById('modalProdusGenericId');
        const modalErrorDiv = document.getElementById('modalError');
 
        addVariantBtn.addEventListener('click', function() {
            if (!currentProdGenericId) return;
            modalProdusGenericIdInput.value = currentProdGenericId;
            modalErrorDiv.textContent = '';
            addVariantForm.reset();
            modal.style.display = 'block';
        });
 
        closeModalButton.onclick = () => modal.style.display = 'none';
        window.onclick = (event) => { if (event.target == modal) modal.style.display = 'none'; };
 
        addVariantForm.addEventListener('submit', function(event) {
            event.preventDefault();
            modalErrorDiv.textContent = '';
            const data = Object.fromEntries(new FormData(addVariantForm).entries());
 
            fetch("{{ url_for('api_adauga_varianta_comerciala') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json().then(json => ({ ok: response.ok, json })))
            .then(({ ok, json }) => {
                if (!ok) throw new Error(json.error || 'A apărut o eroare.');
                
                // Adăugăm noua variantă în lista locală pentru a fi disponibilă imediat
                allVariants.push({ 
                    id: json.id, 
                    text: json.text, 
                    prod_generic_id: parseInt(currentProdGenericId) 
                });

                // Creăm noua opțiune, o adăugăm în dropdown și o selectăm
                const newOption = new Option(json.text, json.id, false, true);
                variantaSelect.appendChild(newOption);
                
                // Închidem fereastra modală
                modal.style.display = 'none';
            })
            .catch(error => {
                modalErrorDiv.textContent = error.message;
            });
        });
    });
    </script>
{% endblock %}
